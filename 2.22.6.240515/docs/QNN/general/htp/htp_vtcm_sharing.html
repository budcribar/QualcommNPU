

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>HTP VTCM Sharing &mdash; Qualcomm® AI Engine Direct</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom_css.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/collapsible-lists/css/tree_view.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="../../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="SubSystem Restart (SSR)" href="htp_ssr.html" />
    <link rel="prev" title="HTP Yielding and Pre-Emption" href="htp_yielding.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Qualcomm® AI Engine Direct
          

          
          </a>

          
            
            
              <div class="version">
                v2.22.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup.html">Setup</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../backend.html">Backend</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../backend.html#backend-specific-pages">Backend Specific Pages</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../dsp/dsp_backend.html">DSP</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="htp_backend.html">HTP</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#api-specializations">API Specializations</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#usage-expectations">Usage Expectations</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#qnn-htp-supported-operations">QNN HTP Supported Operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#qnn-htp-variable-batch">QNN HTP Variable Batch</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#qnn-htp-backend-api">QNN HTP Backend API</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#qnn-htp-performance-infrastructure-api">QNN HTP Performance Infrastructure API</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#qnn-htp-precision">QNN HTP Precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#qnn-htp-fp16-output-difference-between-sm8550-and-sm8650">QNN HTP FP16 output difference between SM8550 and SM8650</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#qnn-htp-deep-learning-bandwidth-compression-dlbc">QNN HTP Deep Learning Bandwidth Compression (DLBC)</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#qnn-htp-setting-number-of-hvx-threads">QNN HTP - Setting Number of HVX Threads</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#qnn-htp-backend-extensions">QNN HTP Backend Extensions</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#qnn-htp-profiling">QNN HTP Profiling</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#qnn-context-binary-size">QNN Context Binary size</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#op-writing-guidelines">Op Writing Guidelines</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#recommendations-for-network-design">Recommendations for Network Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#yielding-and-pre-emption">Yielding and Pre-Emption</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="htp_backend.html#vtcm-sharing">VTCM Sharing</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#subsystem-restart-ssr">SubSystem Restart (SSR)</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#qmem-graph-shared-buffer-only-graph">Qmem Graph (shared_buffer only graph)</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#htp-session-artifact-usage-guidlines">HTP Session &amp; Artifact Usage Guidlines</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#graph-switching-beta">Graph Switching (Beta)</a></li>
<li class="toctree-l4"><a class="reference internal" href="htp_backend.html#benefits-of-batch-inference-and-multi-threaded-inference">Benefits of batch inference and multi-threaded inference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../hta/hta_backend.html">HTA</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lpai/lpai_backend.html">LPAI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cpu/cpu_backend.html">CPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gpu/gpu_backend.html">GPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="../saver/saver_backend.html">Saver</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../op_packages.html">Op Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../converters.html">Converters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operations.html">Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Qualcomm® AI Engine Direct</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../backend.html">Backend</a> &raquo;</li>
        
          <li><a href="htp_backend.html">HTP</a> &raquo;</li>
        
      <li>HTP VTCM Sharing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="htp-vtcm-sharing">
<span id="id1"></span><h1>HTP VTCM Sharing<a class="headerlink" href="#htp-vtcm-sharing" title="Permalink to this heading">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This feature is only enabled on Hexagon V73 onwards and select V69 SoCs.
Sharing is impossible on previous platforms (such as V68, most V69, etc).</p>
</div>
<p>The VTCM sharing feature allows two entities that both want access to VTCM at the same time
to divide the resource between each other.</p>
<p>Prior to the enablement of this feature, two entities in the same process were unable to share the VTCM resource
at the same time. Even if both processes requested page sizes that could fit side-by-side in VTCM (example: 2 x 4MB pages on an 8MB chip),
QNN would always allocate the maximum VTCM size for each page which made sharing impossible prior to the enablement
of this feature</p>
<p>With the new VTCM sharing feature, it is possible for another entity to share a subset of VTCM
alongside QNN. Please note that QNN performance is very senitive to the amount of VTCM available.</p>
<p>Users of this feature will be able to:</p>
<ol class="arabic simple">
<li><p>Have a long-lived entity coexist with QNN.</p></li>
<li><p>Have another entity pass data to or from QNN through VTCM for an inference,
reducing the number of copies to or from DDR.</p></li>
</ol>
<div class="section" id="hap-compute-resource-manager-api-shorthand">
<h2>HAP Compute Resource Manager API Shorthand<a class="headerlink" href="#hap-compute-resource-manager-api-shorthand" title="Permalink to this heading">¶</a></h2>
<p>It is expected that users of this feature are fully familiar with the HAP Compute
Resource Manager and have read the necessary HexagonSDK documentation. It is also
expected that the programmer fully understands the benefits and limitations of using
VTCM in their use case. Furthermore, given that VTCM sharing is an expert level feature, it
is expected that users of this feature have very tight control over their use case
and can reliably control their callflows.</p>
<p>The following shorthand will be used to enhance callflow legibility. Please note
that only <cite>acquire</cite> and <cite>release</cite> will be shown to simplify the diagrams as much
as possible.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// setup(vtcm_size, page_size)</span>
<span class="linenos"> 2</span><span class="n">HAP_compute_res_attr_set_cache_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="linenos"> 3</span><span class="n">HAP_compute_res_attr_set_vtcm_param_v2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">vtcm_size</span><span class="p">,</span><span class="w"> </span><span class="n">page_size</span><span class="p">,</span><span class="w"> </span><span class="n">vtcm_size</span><span class="p">);</span>
<span class="linenos"> 4</span><span class="k">auto</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAP_compute_res_acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">TIMEOUT_US</span><span class="p">);</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="c1">// acquire(vtcm_size, page_size)</span>
<span class="linenos"> 7</span><span class="n">HAP_compute_res_acquire_cached</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">TIMEOUT_US</span><span class="p">);</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="c1">// release()</span>
<span class="linenos">10</span><span class="n">HAP_compute_res_release_cached</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
</pre></div>
</div>
<div class="section" id="overmap">
<h3>Overmap<a class="headerlink" href="#overmap" title="Permalink to this heading">¶</a></h3>
<p>An overmap occurs when page size is larger than the usable portion. In this example <code class="docutils literal notranslate"><span class="pre">acquire(6,8)</span></code>,
VTCM size is 6MB; and page size is 8MB resulting in an 2MB overmap at the end; an unaddressable portion.</p>
<div class="figure align-default">
<img alt="../../_static/resources/vtcm_sharing/overmap.png" src="../../_static/resources/vtcm_sharing/overmap.png" />
</div>
</div>
</div>
<div class="section" id="fundamentals">
<h2>Fundamentals<a class="headerlink" href="#fundamentals" title="Permalink to this heading">¶</a></h2>
<p>In the following diagrams, C1 denotes client 1 which is a user of VTCM.
Unless noted, all clients and QNN are the same priority.</p>
<p>The below diagram illustrates what occurs without VTCM sharing.
QNN requests a maximum-size page mapping at time <code class="docutils literal notranslate"><span class="pre">[1]</span></code> which prevents other
clients from using VTCM. Since C1 and QNN are the same priority C1 follows
the HAP Compute Resource Manager cooperative acquisition rules.</p>
<div class="figure align-default">
<img alt="../../_static/resources/vtcm_sharing/basics_nofeature.png" src="../../_static/resources/vtcm_sharing/basics_nofeature.png" />
</div>
<p>The below diagram illustrates the new callflow.
C1 is free to access its 2MB page while QNN freely accesses its 6MB.
With VTCM sharing there are two key changes:</p>
<ol class="arabic simple">
<li><p>The usable portion of the overmap is aligned to the end.</p></li>
<li><p>If another client’s page size fits in the overmap, it may coexist in the overmap.</p></li>
</ol>
<div class="figure align-default">
<img alt="../../_static/resources/vtcm_sharing/basics_yesfeature.png" src="../../_static/resources/vtcm_sharing/basics_yesfeature.png" />
</div>
</div>
<div class="section" id="vtcm-sharing-rules">
<h2>VTCM Sharing Rules<a class="headerlink" href="#vtcm-sharing-rules" title="Permalink to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>This feature is only enabled for cached acquire and release APIs.</p></li>
<li><p>This feature activates when an overmap is requested, and cannot be disabled.</p></li>
<li><p>Clients must be in the same PD (Process Domain) for coexistence to occur.
This is due to platform enforced security which prevents cross-PD sharing.</p></li>
<li><p>Approved overmap requests will place the usable portion at the end of VTCM, not the beginning.</p></li>
<li><p>To co-exist a non-overmapped entity must make an <code class="docutils literal notranslate"><span class="pre">acquire</span></code> request where <code class="docutils literal notranslate"><span class="pre">page_size</span></code> fits
in the overmap space.</p></li>
<li><p>Order of the two entitys does not matter, only that the requests fit.</p></li>
<li><p>This feature only works within a PD.</p></li>
<li><p>QNN must use &gt;=50% of the hardware VTCM size for its graph size. If it is less this feature will not activate.</p></li>
</ol>
<p><strong>When sharing pointers in VTCM:</strong></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<ol class="arabic simple" start="9">
<li><p>To share VTCM pointers the non-QNN entity must be <strong>maximum priority</strong> and both entities must be in a <strong>Signed PD</strong>.</p></li>
</ol>
</div>
<ol class="arabic simple" start="10">
<li><p>If an entity wants to share a VTCM pointer with QNN, the entity must never release VTCM until QNN returns.</p></li>
</ol>
<blockquote>
<div><p>This prevents a race condition where the non-owner entity tries to access VTCM before acquire is called.</p>
</div></blockquote>
<p><strong>In regards to yielding:</strong></p>
<ol class="arabic simple" start="11">
<li><p>Acquire requests that don’t fit will follow normal cooperative scheduling rules as enforced by the HAP Compute Resource Manager.</p></li>
<li><p>All VTCM clients are individually responsible to yield and save/restore VTCM.</p></li>
<li><p>Yielding is still based on priority.</p></li>
<li><p>If a yield requires multiple clients to be evicted, the HAP Compute Resource Manager
will only do so if all active clients are at a lower priority than the new client requesting
VTCM.</p></li>
<li><p>If the HAP Compute Resource Manager can evict one entity to service an acquire,
it will do that instead of asking each client to release.</p></li>
</ol>
<div class="section" id="native-htp-use-case">
<h3>Native HTP Use Case<a class="headerlink" href="#native-htp-use-case" title="Permalink to this heading">¶</a></h3>
<p>In this use case pointer sharing requires no work from the C1 entity because both C1 and QNN share the same address space.
All that is required is for C1 to hold its VTCM acquire call until QNN is finished at <code class="docutils literal notranslate"><span class="pre">[6]</span></code>.</p>
<div class="figure align-default">
<img alt="../../_static/resources/vtcm_sharing/input_nonrpc.png" src="../../_static/resources/vtcm_sharing/input_nonrpc.png" />
</div>
</div>
<div class="section" id="fastrpc-use-case">
<h3>FastRPC Use Case<a class="headerlink" href="#fastrpc-use-case" title="Permalink to this heading">¶</a></h3>
<p>Like the Native HTP use case, C1 must hold VTCM for the duration of the inference.
In addition, this use case requires sending the VTCM VA back to the CPU so that it can
be passed to QNN.</p>
<div class="figure align-default">
<img alt="../../_static/resources/vtcm_sharing/input_rpc.png" src="../../_static/resources/vtcm_sharing/input_rpc.png" />
</div>
<p>To utilize this call flow the following code sample has been provided to demonstrate
which API calls must be made.</p>
<div class="highlight-CPP notranslate"><div class="highlight"><pre><span></span><span class="c1">//==============================================================================</span>
<span class="c1">//</span>
<span class="c1">//  Copyright (c) 2022, 2024 Qualcomm Technologies, Inc.</span>
<span class="c1">//  All Rights Reserved.</span>
<span class="c1">//  Confidential and Proprietary - Qualcomm Technologies, Inc.</span>
<span class="c1">//</span>
<span class="c1">//==============================================================================</span>

<span class="c1">// From Backend-Specific API Headers</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;QnnHtpMem.h&quot;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// Setup the QNN Device or else registration will fail</span>
<span class="w">  </span><span class="n">Qnn_DeviceHandle_t</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">QNN_SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">QnnDevice_create</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">device</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Do something</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Must bind the device to a context</span>
<span class="w">  </span><span class="n">Qnn_ContextHandle_t</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">QnnContext_create</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span><span class="w"> </span><span class="c1">// user must provide this</span>
<span class="w">                    </span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="c1">// from above</span>
<span class="w">                    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">context</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// This example will use an input tensor. You can do the</span>
<span class="w">  </span><span class="c1">// same for any graph output tensors</span>
<span class="w">  </span><span class="n">Qnn_Tensor_t</span><span class="w"> </span><span class="n">inputTensor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">  </span><span class="c1">// Call graph create setting the right VTCM size</span>
<span class="w">  </span><span class="n">QnnHtpGraph_CustomConfig_t</span><span class="w"> </span><span class="n">customConfig</span><span class="p">;</span>
<span class="w">  </span><span class="n">customConfig</span><span class="p">.</span><span class="n">option</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">QNN_HTP_GRAPH_CONFIG_OPTION_VTCM_SIZE</span><span class="p">;</span>
<span class="w">  </span><span class="n">customConfig</span><span class="p">.</span><span class="n">vtcmSizeInMB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"> </span><span class="c1">// put a number less than hardware page size</span>

<span class="w">  </span><span class="n">QnnGraph_Config_t</span><span class="w"> </span><span class="n">gConfig</span><span class="p">;</span>
<span class="w">  </span><span class="n">gConfig</span><span class="p">.</span><span class="n">option</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">QNN_GRAPH_CONFIG_OPTION_CUSTOM</span><span class="p">;</span>
<span class="w">  </span><span class="n">gConfig</span><span class="p">.</span><span class="n">customConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">customConfig</span><span class="p">;</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">QnnGraph_Config_t</span><span class="o">*</span><span class="w"> </span><span class="n">graphConfig</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="o">&amp;</span><span class="n">gConfig</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">};</span>

<span class="w">  </span><span class="c1">// Use the new graph size</span>
<span class="w">  </span><span class="n">Qnn_GraphHandle_t</span><span class="w"> </span><span class="n">graph</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">Qnn_ErrorHandle_t</span><span class="w"> </span><span class="n">graphError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QnnGraph_create</span><span class="p">(</span>
<span class="w">                        </span><span class="n">context</span><span class="p">,</span><span class="w">     </span><span class="c1">// from above</span>
<span class="w">                        </span><span class="s">&quot;QnnGraph&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// name</span>
<span class="w">                        </span><span class="n">graphConfig</span><span class="p">,</span><span class="w"> </span><span class="c1">// from above</span>
<span class="w">                        </span><span class="o">&amp;</span><span class="n">graph</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">QNN_SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">graphError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Do something</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Finalize the graph</span>

<span class="w">  </span><span class="c1">// This call corresponds with step #2</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">dspVirtualAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDspVirtualAddress</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Structs from QnnHtpMem.h</span>
<span class="w">  </span><span class="n">QnnMemHtp_Descriptor_t</span><span class="w"> </span><span class="n">inputHtpDescriptor</span><span class="p">{</span>
<span class="w">      </span><span class="p">.</span><span class="n">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">QNN_HTP_MEM_QURT</span><span class="p">,</span><span class="w">   </span><span class="c1">// const from the header QnnHtpMem.h</span>
<span class="w">      </span><span class="p">.</span><span class="n">size</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">INPUT_TENSOR_SIZE</span><span class="p">,</span><span class="w">  </span><span class="c1">// user must provide this</span>
<span class="w">      </span><span class="p">.</span><span class="n">qurtAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dspVirtualAddress</span><span class="p">};</span>

<span class="w">  </span><span class="c1">// Structs from QnnMem.h</span>
<span class="w">  </span><span class="n">Qnn_MemShape_t</span><span class="w"> </span><span class="n">qnnMemShapeInput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">numDim</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">INPUT_TENSOR_DIMS_LEN</span><span class="p">,</span><span class="w">  </span><span class="c1">// user must provide this</span>
<span class="w">                                     </span><span class="p">.</span><span class="n">dimSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INPUT_TENSOR_DIMS</span><span class="p">,</span><span class="w">      </span><span class="c1">// user must provide this</span>
<span class="w">                                     </span><span class="p">.</span><span class="n">shapeConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">};</span>

<span class="w">  </span><span class="n">Qnn_MemDescriptor_t</span><span class="w"> </span><span class="n">inputQnnDescriptor</span><span class="p">{</span>
<span class="w">      </span><span class="p">.</span><span class="n">memShape</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">qnnMemShapeInput</span><span class="p">,</span><span class="w">     </span><span class="c1">// from above</span>
<span class="w">      </span><span class="p">.</span><span class="n">dataType</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">INPUT_TENSOR_DTYPE</span><span class="p">,</span><span class="w">   </span><span class="c1">// user must provide this</span>
<span class="w">      </span><span class="p">.</span><span class="n">memType</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">QNN_MEM_TYPE_CUSTOM</span><span class="p">,</span><span class="w">  </span><span class="c1">// from QnnHtpMem.h</span>
<span class="w">      </span><span class="p">.</span><span class="n">customInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">inputHtpDescriptor</span><span class="p">,</span><span class="w">  </span><span class="c1">// above</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="n">Qnn_MemHandle_t</span><span class="w"> </span><span class="n">inputMemHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Register the memory, note that the context is the same as above that</span>
<span class="w">  </span><span class="c1">// used the Qnn_DeviceHandle_t</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QnnMem_register</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">inputQnnDescriptor</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">inputMemHandle</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">QNN_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Do something</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">inputTensor</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">memType</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">QNN_TENSORMEMTYPE_MEMHANDLE</span><span class="p">;</span>
<span class="w">  </span><span class="n">inputTensor</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">memHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputMemHandle</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// You can now use the inputTensor as an arugment to graph execute</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pre-emption">
<h2>Pre Emption<a class="headerlink" href="#pre-emption" title="Permalink to this heading">¶</a></h2>
<p>Pre-emption is still a concern in that the HAP Compute Resource Manager expects cooperative pre-emption from
its clients.</p>
<div class="section" id="two-graphs-in-the-same-pd">
<h3>Two Graphs in the Same PD<a class="headerlink" href="#two-graphs-in-the-same-pd" title="Permalink to this heading">¶</a></h3>
<p>In this use case two graphs (QNN1,2) coexist with C1. Graph 2 wants to execute and because it is the
high priority, the HAP Compute Resource Manager will trigger a preemption. C1 is not preempted because
it is in the same PD as QNN, and it’s VTCM usage fits in Graph 2’s overmap space. Therefore, only graph 1
is asked to yield.</p>
<div class="figure align-default">
<img alt="../../_static/resources/vtcm_sharing/preempt_2graphs.png" src="../../_static/resources/vtcm_sharing/preempt_2graphs.png" />
</div>
</div>
<div class="section" id="two-pds-incoming-is-higher-priority">
<h3>Two PDs - Incoming is Higher Priority<a class="headerlink" href="#two-pds-incoming-is-higher-priority" title="Permalink to this heading">¶</a></h3>
<p>In this case, C1 and QNN are in the same PD, and PD2 is any client in another PD. VTCM sharing is impossible across PDs
so normal scheduling rules follow. PD2 is a higher priority than either client in PD1 so the HAP Compute
Resource Manager asks all active clients in PD1 to yield, then giving VTCM to PD2.</p>
<div class="figure align-default">
<img alt="../../_static/resources/vtcm_sharing/preempt_2pd.png" src="../../_static/resources/vtcm_sharing/preempt_2pd.png" />
</div>
</div>
<div class="section" id="two-pds-incoming-is-lower-priority">
<h3>Two PDs - Incoming is Lower Priority<a class="headerlink" href="#two-pds-incoming-is-lower-priority" title="Permalink to this heading">¶</a></h3>
<p>This case is identical to the previous, except one active client in PD1 is higher priority than the client in PD2.
Following the normal queue rules, PD2 must wait until the high priority C1 entity decides to release.
At that point the priority of PD2 is greater than the priority of PD1, and a release request is sent to QNN.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Please note that in this diagram the release at step [4] is not triggered by step [3]. Instead
PD2 must wait until all high priority clients release, then the Hexagon OS will initiate preemption.</p>
</div>
<div class="figure align-default">
<img alt="../../_static/resources/vtcm_sharing/preempt_2pd_nopreempt.png" src="../../_static/resources/vtcm_sharing/preempt_2pd_nopreempt.png" />
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="htp_ssr.html" class="btn btn-neutral float-right" title="SubSystem Restart (SSR)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="htp_yielding.html" class="btn btn-neutral float-left" title="HTP Yielding and Pre-Emption" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020-2024, Qualcomm Technologies, Inc..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>